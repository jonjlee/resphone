import"./styles-DrZedr2-.js";document.addEventListener("DOMContentLoaded",()=>{const I="https://pub-64c5ab9ca3b24895a1f7903d51639e2d.r2.dev/resphone.json",L="https://resphone.jonjlee.workers.dev";if(!sessionStorage.getItem("authenticated")){window.location.href="index.html";return}const d=document.getElementById("applyButton"),E=document.getElementById("editContactsButton"),m=document.getElementById("customOption"),h=document.getElementById("customNumberField"),f=document.getElementById("customNumberInput"),b=document.getElementById("customNumberError"),l=document.querySelector(".number-options"),C=document.getElementById("toggleUpdates"),O=document.getElementById("updatesContent"),$=document.getElementById("updatesList");let p=null,n=null,u=!1;E.addEventListener("click",()=>{!u&&m.classList.contains("selected")&&(m.classList.remove("selected"),h.style.display="none",f.value="",b.style.display="none",p=null),u=!u;const e=E.querySelector(".icon"),i=e==null?void 0:e.querySelector("i");u?(e.style.display="inline-block",i&&(i.className="fas fa-times"),E.querySelector("span:not(.icon)").textContent="Discard Changes"):(e.style.display="inline-block",i&&(i.className="fas fa-edit"),E.querySelector("span:not(.icon)").textContent="Edit Contacts"),d.textContent=u?"Save Changes":"Apply Forwarding",v(),updateApplyButtonState()}),C.addEventListener("click",()=>{const e=O.style.display==="none";O.style.display=e?"block":"none",C.querySelector(".icon i").className=e?"fas fa-chevron-up":"fas fa-chevron-down"});function q(e){$.innerHTML="",e.slice().reverse().forEach(i=>{const s=document.createElement("li");s.innerHTML=`<strong>${i.ts}:</strong> ${i.update}`,$.appendChild(s)})}document.querySelector(".logout-button").addEventListener("click",e=>{e.preventDefault(),sessionStorage.removeItem("authenticated"),sessionStorage.removeItem("password"),window.location.href="index.html"});function v(){if(!n)return;const e=[];u&&l.querySelectorAll(".edit-mode").forEach(c=>{const t=c.querySelector(".contact-name"),o=c.querySelector(".contact-phone");t&&o&&e.push({name:t.value,phone:o.value})}),l.querySelectorAll(".number-option:not(#customOption)").forEach(a=>a.remove());const s=l.querySelector(".has-text-centered");if(s&&s.remove(),m.style.display=u?"none":"block",h.style.display="none",f.value="",b.style.display="none",u){n.contacts.forEach((c,t)=>{var r,S;const o=document.createElement("div");o.className="number-option edit-mode",o.innerHTML=`
                    <div class="field is-horizontal">
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-name" type="text" value="${((r=e[t])==null?void 0:r.name)||c.name}" placeholder="Name">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-phone" type="tel" value="${((S=e[t])==null?void 0:S.phone)||c.phone}" placeholder="Phone">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control buttons">
                                    <button class="button is-small move-up" title="Move Up">
                                        <span class="icon">
                                            <i class="fas fa-arrow-up"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small move-down" title="Move Down">
                                        <span class="icon">
                                            <i class="fas fa-arrow-down"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small delete-contact">
                                        <span class="icon">
                                            <i class="far fa-trash-alt"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,l.insertBefore(o,m),o.querySelector(".delete-contact").addEventListener("click",()=>{n.contacts.splice(t,1),v()}),o.querySelector(".move-up").addEventListener("click",()=>{if(t>0){const g=n.contacts[t];n.contacts[t]=n.contacts[t-1],n.contacts[t-1]=g,n.selected===g.phone&&(n.selected=g.phone),v();const w=l.querySelector(`.edit-mode:nth-child(${t})`);w&&w.classList.add("selected")}}),o.querySelector(".move-down").addEventListener("click",()=>{if(t<n.contacts.length-1){const g=n.contacts[t];n.contacts[t]=n.contacts[t+1],n.contacts[t+1]=g,n.selected===g.phone&&(n.selected=g.phone),v();const w=l.querySelector(`.edit-mode:nth-child(${t+2})`);w&&w.classList.add("selected")}})});const a=document.createElement("div");a.className="number-option",a.innerHTML=`
                <button class="button is-info is-small is-fullwidth">
                    <span class="icon">
                        <i class="fas fa-plus"></i>
                    </span>
                    <span>Add Contact</span>
                </button>
            `,l.insertBefore(a,m),a.querySelector("button").addEventListener("click",()=>{const c=[];l.querySelectorAll(".edit-mode").forEach(o=>{const r=o.querySelector(".contact-name"),S=o.querySelector(".contact-phone");r&&S&&c.push({name:r.value,phone:S.value})}),n.contacts.push({name:"",phone:""}),c.forEach((o,r)=>{n.contacts[r]&&(n.contacts[r]={name:o.name,phone:o.phone})}),v()})}else{n.contacts.forEach(t=>{const o=document.createElement("div");o.className="number-option",o.dataset.value=t.phone,o.dataset.name=t.name,o.textContent=`${t.name} - (${t.phone.slice(0,3)}) ${t.phone.slice(3,6)}-${t.phone.slice(6)}`,l.insertBefore(o,m)});const a=n.selected,c=l.querySelector(`[data-value="${a}"]`);c?(c.classList.add("selected"),p=c):(m.classList.add("selected"),p=m,h.style.display="block",f.value=a)}N()}function N(){const e=l.querySelectorAll(".number-option");e.forEach(i=>{i.addEventListener("click",function(){e.forEach(s=>s.classList.remove("selected")),this.classList.add("selected"),p=this,this.dataset.value==="custom"?h.style.display="block":(h.style.display="none",f.value="",b.style.display="none")})})}f.addEventListener("input",function(){const e=this.value.trim();e&&!/^\d+$/.test(e)?b.style.display="block":b.style.display="none"}),d.addEventListener("click",async function(){if(u){const e=[];if(l.querySelectorAll(".edit-mode").forEach(s=>{const a=s.querySelector(".contact-name").value.trim(),c=s.querySelector(".contact-phone").value.trim();a&&c&&/^\d+$/.test(c)&&e.push({name:a,phone:c})}),e.length===0){y("Please add at least one valid contact","danger");return}try{d.disabled=!0,d.textContent="Saving...",y("Saving contacts...","info");const s=sessionStorage.getItem("password"),a=Math.floor(Date.now()/1e3),c=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${a}|${s}`)).then(o=>Array.from(new Uint8Array(o)).map(r=>r.toString(16).padStart(2,"0")).join("")),t=await fetch(`${L}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:c,utc:a,contacts:e,selected:n.selected})});if(!t.ok)throw new Error("Failed to update contacts");n=await t.json(),q(n.updates),y("Contacts updated successfully","success"),u=!1,E.querySelector("span:not(.icon)").textContent="Edit Contacts",d.textContent="Apply Forwarding",v()}catch(s){console.error("Error updating contacts:",s),y("Failed to update contacts","danger")}finally{d.disabled=!1}}else{if(!p){alert("Please select a forwarding number");return}let e;if(p.dataset.value==="custom"){if(e=f.value.trim(),!e||!/^\d+$/.test(e)){b.style.display="block";return}const i=n.contacts.find(s=>s.phone===e);if(i){const s=l.querySelector(`[data-value="${e}"]`);s&&(l.querySelectorAll(".number-option").forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),p=s,h.style.display="none",f.value="",e=i.phone)}}else e=p.dataset.value;try{d.disabled=!0,d.textContent="Applying...",y("Applying forwarding number...","info");const i=sessionStorage.getItem("password"),s=Math.floor(Date.now()/1e3),a=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${s}|${i}`)).then(o=>Array.from(new Uint8Array(o)).map(r=>r.toString(16).padStart(2,"0")).join("")),c=await fetch(`${L}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:a,utc:s,contacts:n.contacts,selected:e})});if(!c.ok)throw new Error("Failed to update configuration");n=await c.json(),q(n.updates),y("Forwarding number updated successfully","success");const t=l.querySelector(`[data-value="${n.selected}"]`);t&&(l.querySelectorAll(".number-option").forEach(o=>o.classList.remove("selected")),t.classList.add("selected"),p=t,h.style.display="none",f.value="")}catch(i){console.error("Error updating forwarding number:",i),y("Failed to update forwarding number","danger")}finally{d.disabled=!1,d.textContent="Apply Forwarding"}}});function y(e,i="info"){const s=document.querySelector(".notification");s&&s.remove();const a=document.createElement("div");a.className=`notification is-${i}`,a.textContent=e;const c=document.querySelector(".box");c.parentNode.insertBefore(a,c.nextSibling)}async function k(){try{const e=await fetch(I);if(!e.ok)throw new Error("Failed to fetch configuration");n=await e.json(),v(),n.updates&&q(n.updates)}catch(e){console.error("Error fetching configuration:",e),y("Failed to load forwarding numbers","danger")}}k()});
