import"./styles-DrZedr2-.js";document.addEventListener("DOMContentLoaded",()=>{const C="https://pub-64c5ab9ca3b24895a1f7903d51639e2d.r2.dev/resphone.json",w="https://resphone.jonjlee.workers.dev";if(!sessionStorage.getItem("authenticated")){window.location.href="index.html";return}const r=document.getElementById("applyButton"),b=document.getElementById("editContactsButton"),m=document.getElementById("customOption"),h=document.getElementById("customNumberField"),f=document.getElementById("customNumberInput"),g=document.getElementById("customNumberError"),i=document.querySelector(".number-options"),S=document.getElementById("toggleUpdates"),L=document.getElementById("updatesContent"),q=document.getElementById("updatesList");let d=null,o=null,u=!1;b.addEventListener("click",()=>{!u&&m.classList.contains("selected")&&(m.classList.remove("selected"),h.style.display="none",f.value="",g.style.display="none",d=null),u=!u;const e=b.querySelector(".icon"),s=e==null?void 0:e.querySelector("i");u?(e.style.display="inline-block",s&&(s.className="fas fa-times"),b.querySelector("span:not(.icon)").textContent="Discard Changes"):(e.style.display="inline-block",s&&(s.className="fas fa-edit"),b.querySelector("span:not(.icon)").textContent="Edit Contacts"),r.textContent=u?"Save Changes":"Apply Forwarding",v(),updateApplyButtonState()}),S.addEventListener("click",()=>{const e=L.style.display==="none";L.style.display=e?"block":"none",S.querySelector(".icon i").className=e?"fas fa-chevron-up":"fas fa-chevron-down"});function E(e){q.innerHTML="",e.slice().reverse().forEach(s=>{const t=document.createElement("li");t.innerHTML=`<strong>${s.ts}:</strong> ${s.update}`,q.appendChild(t)})}document.querySelector(".logout-button").addEventListener("click",e=>{e.preventDefault(),sessionStorage.removeItem("authenticated"),sessionStorage.removeItem("password"),window.location.href="index.html"});function v(){if(!o)return;i.querySelectorAll(".number-option:not(#customOption)").forEach(t=>t.remove());const s=i.querySelector(".has-text-centered");if(s&&s.remove(),m.style.display=u?"none":"block",h.style.display="none",f.value="",g.style.display="none",u){o.contacts.forEach((a,n)=>{const c=document.createElement("div");c.className="number-option edit-mode",c.innerHTML=`
                    <div class="field is-horizontal">
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-name" type="text" value="${a.name}" placeholder="Name">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-phone" type="tel" value="${a.phone}" placeholder="Phone">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control buttons">
                                    <button class="button is-small move-up" title="Move Up">
                                        <span class="icon">
                                            <i class="fas fa-arrow-up"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small move-down" title="Move Down">
                                        <span class="icon">
                                            <i class="fas fa-arrow-down"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small delete-contact">
                                        <span class="icon">
                                            <i class="far fa-trash-alt"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,i.insertBefore(c,m),c.querySelector(".delete-contact").addEventListener("click",()=>{o.contacts.splice(n,1),v()}),c.querySelector(".move-up").addEventListener("click",()=>{if(n>0){const l=o.contacts[n];o.contacts[n]=o.contacts[n-1],o.contacts[n-1]=l,o.selected===l.phone&&(o.selected=l.phone),v();const p=i.querySelector(`.edit-mode:nth-child(${n})`);p&&p.classList.add("selected")}}),c.querySelector(".move-down").addEventListener("click",()=>{if(n<o.contacts.length-1){const l=o.contacts[n];o.contacts[n]=o.contacts[n+1],o.contacts[n+1]=l,o.selected===l.phone&&(o.selected=l.phone),v();const p=i.querySelector(`.edit-mode:nth-child(${n+2})`);p&&p.classList.add("selected")}})});const t=document.createElement("div");t.className="number-option",t.innerHTML=`
                <button class="button is-info is-small is-fullwidth">
                    <span class="icon">
                        <i class="fas fa-plus"></i>
                    </span>
                    <span>Add Contact</span>
                </button>
            `,i.insertBefore(t,m),t.querySelector("button").addEventListener("click",()=>{o.contacts.push({name:"",phone:""}),v()})}else{o.contacts.forEach(n=>{const c=document.createElement("div");c.className="number-option",c.dataset.value=n.phone,c.dataset.name=n.name,c.textContent=`${n.name} - (${n.phone.slice(0,3)}) ${n.phone.slice(3,6)}-${n.phone.slice(6)}`,i.insertBefore(c,m)});const t=o.selected,a=i.querySelector(`[data-value="${t}"]`);a?(a.classList.add("selected"),d=a):(m.classList.add("selected"),d=m,h.style.display="block",f.value=t)}$()}function $(){const e=i.querySelectorAll(".number-option");e.forEach(s=>{s.addEventListener("click",function(){e.forEach(t=>t.classList.remove("selected")),this.classList.add("selected"),d=this,this.dataset.value==="custom"?h.style.display="block":(h.style.display="none",f.value="",g.style.display="none")})})}f.addEventListener("input",function(){const e=this.value.trim();e&&!/^\d+$/.test(e)?g.style.display="block":g.style.display="none"}),r.addEventListener("click",async function(){if(u){const e=[];if(i.querySelectorAll(".edit-mode").forEach(t=>{const a=t.querySelector(".contact-name").value.trim(),n=t.querySelector(".contact-phone").value.trim();a&&n&&/^\d+$/.test(n)&&e.push({name:a,phone:n})}),e.length===0){y("Please add at least one valid contact","danger");return}try{r.disabled=!0,r.textContent="Saving...",y("Saving contacts...","info");const t=sessionStorage.getItem("password"),a=Math.floor(Date.now()/1e3),n=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${a}|${t}`)).then(l=>Array.from(new Uint8Array(l)).map(p=>p.toString(16).padStart(2,"0")).join("")),c=await fetch(`${w}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:n,utc:a,contacts:e,selected:o.selected})});if(!c.ok)throw new Error("Failed to update contacts");o=await c.json(),E(o.updates),y("Contacts updated successfully","success"),u=!1,b.querySelector("span:not(.icon)").textContent="Edit Contacts",r.textContent="Apply Forwarding",v()}catch(t){console.error("Error updating contacts:",t),y("Failed to update contacts","danger")}finally{r.disabled=!1}}else{if(!d){alert("Please select a forwarding number");return}let e;if(d.dataset.value==="custom"){if(e=f.value.trim(),!e||!/^\d+$/.test(e)){g.style.display="block";return}const s=o.contacts.find(t=>t.phone===e);if(s){const t=i.querySelector(`[data-value="${e}"]`);t&&(i.querySelectorAll(".number-option").forEach(a=>a.classList.remove("selected")),t.classList.add("selected"),d=t,h.style.display="none",f.value="",e=s.phone)}}else e=d.dataset.value;try{r.disabled=!0,r.textContent="Applying...",y("Applying forwarding number...","info");const s=sessionStorage.getItem("password"),t=Math.floor(Date.now()/1e3),a=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${t}|${s}`)).then(l=>Array.from(new Uint8Array(l)).map(p=>p.toString(16).padStart(2,"0")).join("")),n=await fetch(`${w}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:a,utc:t,contacts:o.contacts,selected:e})});if(!n.ok)throw new Error("Failed to update configuration");o=await n.json(),E(o.updates),y("Forwarding number updated successfully","success");const c=i.querySelector(`[data-value="${o.selected}"]`);c&&(i.querySelectorAll(".number-option").forEach(l=>l.classList.remove("selected")),c.classList.add("selected"),d=c,h.style.display="none",f.value="")}catch(s){console.error("Error updating forwarding number:",s),y("Failed to update forwarding number","danger")}finally{r.disabled=!1,r.textContent="Apply Forwarding"}}});function y(e,s="info"){const t=document.querySelector(".notification");t&&t.remove();const a=document.createElement("div");a.className=`notification is-${s}`,a.textContent=e;const n=document.querySelector(".box");n.parentNode.insertBefore(a,n.nextSibling)}async function N(){try{const e=await fetch(C);if(!e.ok)throw new Error("Failed to fetch configuration");o=await e.json(),v(),o.updates&&E(o.updates)}catch(e){console.error("Error fetching configuration:",e),y("Failed to load forwarding numbers","danger")}}N()});
