import"./styles-DpdKvta9.js";document.addEventListener("DOMContentLoaded",()=>{const A="https://pub-64c5ab9ca3b24895a1f7903d51639e2d.r2.dev/resphone.json",N="https://resphone.jonjlee.workers.dev";if(!localStorage.getItem("authenticated")){window.location.href="index.html";return}const u=document.getElementById("applyButton"),S=document.getElementById("editContactsButton"),E=document.getElementById("customOption"),y=document.getElementById("customNumberField"),p=document.getElementById("customNumberInput"),v=document.getElementById("customNumberError"),g=document.querySelector(".number-options"),i=document.querySelector(".contact-options"),O=document.getElementById("toggleUpdates"),$=document.getElementById("updatesContent"),k=document.getElementById("updatesList");let r=null,c=null,w=null,d=!1;S.addEventListener("click",()=>{!d&&E.classList.contains("selected")&&(E.classList.remove("selected"),y.style.display="none",p.value="",v.style.display="none",r=null),d=!d;const e=S.querySelector(".icon"),o=e==null?void 0:e.querySelector("i");d?(w=JSON.parse(JSON.stringify(c)),e.style.display="inline-block",o&&(o.className="fas fa-times"),S.querySelector("span:not(.icon)").textContent="Discard Changes"):(w=null,e.style.display="inline-block",o&&(o.className="fas fa-edit"),S.querySelector("span:not(.icon)").textContent="Edit Contacts"),u.textContent=d?"Save Changes":"Apply Forwarding",h(d?w:c)}),O.addEventListener("click",()=>{const e=$.style.display==="none";$.style.display=e?"block":"none",O.querySelector(".icon i").className=e?"fas fa-chevron-up":"fas fa-chevron-down"});function C(e){k.innerHTML="",e.slice().reverse().forEach(o=>{const s=document.createElement("li");s.innerHTML=`<strong>${o.ts}:</strong> ${o.update}`,k.appendChild(s)})}document.querySelector(".logout-button").addEventListener("click",e=>{e.preventDefault(),localStorage.removeItem("authenticated"),localStorage.removeItem("password"),window.location.href="index.html"});function h(e){if(!e)return;i.innerHTML="";const o=g.querySelector(".has-text-centered");o&&o.remove();const s=document.getElementById("noneOption");if(E.style.display=d?"none":"block",s.style.display=d?"none":"block",y.style.display="none",p.value="",v.style.display="none",d){e.contacts.forEach((n,t)=>{const l=document.createElement("div");l.className="number-option edit-mode",l.innerHTML=`
                    <div class="field is-horizontal">
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-name" type="text" value="${n.name}" placeholder="Name">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control">
                                    <input class="input contact-phone" type="tel" value="${n.phone}" placeholder="Phone">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control buttons">
                                    <button class="button is-small move-up" title="Move Up">
                                        <span class="icon">
                                            <i class="fas fa-arrow-up"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small move-down" title="Move Down">
                                        <span class="icon">
                                            <i class="fas fa-arrow-down"></i>
                                        </span>
                                    </button>
                                    <button class="button is-small delete-contact">
                                        <span class="icon">
                                            <i class="far fa-trash-alt"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,i.appendChild(l);const b=l.querySelector(".contact-name"),q=l.querySelector(".contact-phone");b.addEventListener("blur",()=>{e.contacts[t].name=b.value}),q.addEventListener("blur",()=>{e.contacts[t].phone=q.value}),l.querySelector(".delete-contact").addEventListener("click",()=>{e.contacts.splice(t,1),h(e)}),l.querySelector(".move-up").addEventListener("click",()=>{if(t>0){const f=e.contacts[t];e.contacts[t]=e.contacts[t-1],e.contacts[t-1]=f,e.selected===f.phone&&(e.selected=f.phone),h(e);const L=i.querySelector(`.edit-mode:nth-child(${t})`);L&&L.classList.add("selected")}}),l.querySelector(".move-down").addEventListener("click",()=>{if(t<e.contacts.length-1){const f=e.contacts[t];e.contacts[t]=e.contacts[t+1],e.contacts[t+1]=f,e.selected===f.phone&&(e.selected=f.phone),h(e);const L=i.querySelector(`.edit-mode:nth-child(${t+2})`);L&&L.classList.add("selected")}})});const a=document.createElement("div");a.className="number-option",a.innerHTML=`
                <div class="has-text-right">
                    <button class="button is-primary is-rounded is-small">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>Add Contact</span>
                    </button>
                </div>
            `,i.appendChild(a),a.querySelector("button").addEventListener("click",()=>{e.contacts.push({name:"",phone:""}),h(e)})}else{e.contacts.forEach(n=>{const t=document.createElement("div");t.className="number-option",t.dataset.value=n.phone,t.dataset.name=n.name,t.textContent=`${n.name} - (${n.phone.slice(0,3)}) ${n.phone.slice(3,6)}-${n.phone.slice(6)}`,i.appendChild(t)});const a=e.selected;if(a==="none")s.classList.add("selected"),r=s;else{const n=i.querySelector(`[data-value="${a}"]`);n?(n.classList.add("selected"),r=n):(E.classList.add("selected"),r=E,y.style.display="block",p.value=a)}}I()}function I(){const e=[...g.querySelectorAll(".number-option"),...i.querySelectorAll(".number-option")];e.forEach(o=>{o.addEventListener("click",function(){e.forEach(s=>s.classList.remove("selected")),this.classList.add("selected"),r=this,this.dataset.value==="custom"?y.style.display="block":(y.style.display="none",p.value="",v.style.display="none")})})}p.addEventListener("input",function(){const e=this.value.trim();e&&!/^\d+$/.test(e)?v.style.display="block":v.style.display="none"}),u.addEventListener("click",async function(){if(d){const e=[],o=i.querySelectorAll(".edit-mode");let s=!1;if(o.forEach(a=>{const n=a.querySelector(".contact-name").value.trim(),t=a.querySelector(".contact-phone").value.trim(),l=/^(1?\d{10})$/.test(t);n&&t&&(l?e.push({name:n,phone:t}):s=!0)}),s){m("Phone numbers must be 10 digits","danger");return}if(e.length===0){m("Please add at least one valid contact","danger");return}try{u.disabled=!0,u.textContent="Saving...",m("Saving contacts...","info");const a=localStorage.getItem("password"),n=Math.floor(Date.now()/1e3),t=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${n}|${a}`)).then(b=>Array.from(new Uint8Array(b)).map(q=>q.toString(16).padStart(2,"0")).join("")),l=await fetch(`${N}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:t,utc:n,contacts:w.contacts,selected:c.selected})});if(!l.ok)throw new Error("Failed to update contacts");c=await l.json(),w=null,C(c.updates),m("Contacts updated successfully","success"),d=!1,S.querySelector("span:not(.icon)").textContent="Edit Contacts",u.textContent="Apply Forwarding",h(c)}catch(a){console.error("Error updating contacts:",a),m("Failed to update contacts","danger")}finally{u.disabled=!1}}else{if(!r){alert("Please select a forwarding number");return}let e;if(r.dataset.value==="custom"){if(e=p.value.trim(),!e||!/^\d+$/.test(e)){v.style.display="block";return}const o=c.contacts.find(s=>s.phone===e);if(o){const s=i.querySelector(`[data-value="${e}"]`);s&&([...g.querySelectorAll(".number-option"),...i.querySelectorAll(".number-option")].forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),r=s,y.style.display="none",p.value="",e=o.phone)}}else r.dataset.value==="none"?e="none":e=r.dataset.value;try{u.disabled=!0,u.textContent="Applying...",m("Applying forwarding number...","info");const o=localStorage.getItem("password"),s=Math.floor(Date.now()/1e3),a=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(`${s}|${o}`)).then(l=>Array.from(new Uint8Array(l)).map(b=>b.toString(16).padStart(2,"0")).join("")),n=await fetch(`${N}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:a,utc:s,contacts:c.contacts,selected:e})});if(!n.ok)throw new Error("Failed to update configuration");c=await n.json(),C(c.updates),m("Forwarding number updated successfully","success");const t=i.querySelector(`[data-value="${c.selected}"]`);t?([...g.querySelectorAll(".number-option"),...i.querySelectorAll(".number-option")].forEach(l=>l.classList.remove("selected")),t.classList.add("selected"),r=t,y.style.display="none",p.value=""):c.selected==="none"&&([...g.querySelectorAll(".number-option"),...i.querySelectorAll(".number-option")].forEach(l=>l.classList.remove("selected")),noneOption.classList.add("selected"),r=noneOption,y.style.display="none",p.value="")}catch(o){console.error("Error updating forwarding number:",o),m("Failed to update forwarding number","danger")}finally{u.disabled=!1,u.textContent="Apply Forwarding"}}});function m(e,o="info"){const s=document.querySelector(".notification");s&&s.remove();const a=document.createElement("div");a.className=`notification is-${o}`,a.textContent=e;const n=document.querySelector(".box");n.parentNode.insertBefore(a,n.nextSibling)}async function B(){try{const e=await fetch(A,{cache:"no-store"});if(!e.ok)throw new Error("Failed to fetch configuration");c=await e.json(),h(c),c.updates&&C(c.updates)}catch(e){console.error("Error fetching configuration:",e),m("Failed to load forwarding numbers","danger")}}B()});
